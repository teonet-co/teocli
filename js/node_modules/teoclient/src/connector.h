/**
 * File:   connector.h
 * Author: Alexander Ksenofontov <aksenofo@yahoo.ru>
 *
 * Created on August 3, 2016, 12:32 PM
 */

#pragma once


#include <stddef.h>
#include <sys/types.h>
#include <string>
#include <unistd.h>

#include "libteol0/teonet_l0_client.h"

#include <nan.h>
#include "teo_aux.h"

class Connector: public Nan::ObjectWrap {
public:
    Connector(const std::string& ip, int port)
    : connector_(nullptr)
    , ip_(ip)
    , port_(port)
    {}

    virtual ~Connector();

    static v8::Local<v8::Value> createNewInstance(const Nan::FunctionCallbackInfo<v8::Value>& info);

    static NAN_MODULE_INIT(Init);

private:

    static NAN_METHOD(New); // constructor

    static NAN_METHOD(Login); // Login method

    static NAN_METHOD(Send); // Send

    static NAN_METHOD(Recv); // Rec

    static NAN_METHOD(Sleep); // Sleep

    static Nan::Persistent<v8::Function> constructor;

    bool connect();

    bool is_connected() const { return connector_; }

    ssize_t login(const char* host_name);

    ssize_t send(int cmd, const char *peer_name, const void *data, size_t data_length);

    ssize_t recv();

    size_t length() const {
	assert(connector_);
	return reinterpret_cast<teoLNullCPacket*>(connector_->read_buffer)->data_length;
    }

    const char* name() const {
	assert(connector_);
	return reinterpret_cast<teoLNullCPacket*>(connector_->read_buffer)->peer_name;
    }

    int cmd() const {
	assert(connector_);
	return reinterpret_cast<teoLNullCPacket*>(connector_->read_buffer)->cmd;
    }

    const void* arp_data() const {
	assert(connector_);
	auto cp(reinterpret_cast<teoLNullCPacket*>(connector_->read_buffer));
	return cp->peer_name + cp->peer_name_length;
    }

    v8::Local<v8::Value> fnCMD_L_PEERS_ANSWER(const Nan::FunctionCallbackInfo<v8::Value>& info);

    //--------------------------------------------------------

    DECL_CONSTANT(CMD_L_ECHO, CMD_L_ECHO);
    DECL_CONSTANT(CMD_L_ECHO_ANSWER, CMD_L_ECHO_ANSWER);
    DECL_CONSTANT(CMD_L_PEERS, CMD_L_PEERS);
    DECL_CONSTANT(CMD_L_PEERS_ANSWER, CMD_L_PEERS_ANSWER);
    DECL_CONSTANT(CMD_L_AUTH, CMD_L_AUTH);
    DECL_CONSTANT(CMD_L_AUTH_ANSWER, CMD_L_AUTH_ANSWER);
    DECL_CONSTANT(CMD_L_L0_CLIENTS, CMD_L_L0_CLIENTS);
    DECL_CONSTANT(CMD_L_L0_CLIENTS_ANSWER, CMD_L_L0_CLIENTS_ANSWER);
    DECL_CONSTANT(CMD_L_SUBSCRIBE_ANSWER, CMD_L_SUBSCRIBE_ANSWER);
    DECL_CONSTANT(CMD_L_END, CMD_L_END);


private:

    teoLNullConnectData* connector_;

    std::string ip_;

    int port_;
};

